# ============================================
# Validacao de Manifests Kubernetes
# Roda em PRs que modificam arquivos k8s
# ============================================
name: Validate K8s Manifests

on:
  pull_request:
    branches:
      - master
      - main
    paths:
      - 'v4/k8s/**'
      - '.github/workflows/validate-k8s.yml'

  # Permite rodar manualmente
  workflow_dispatch:

env:
  KUBERNETES_VERSION: "1.32.0"

jobs:
  # ==========================================
  # Job 1: Validar YAML com kubeval
  # ==========================================
  kubeval:
    name: Kubeval - YAML Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          wget -q https://github.com/instrumenta/kubeval/releases/download/v0.16.1/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate base manifests
        run: |
          echo "üîç Validando manifests base..."
          find v4/k8s/base -name '*.yaml' -type f | while read file; do
            echo "  Checking: $file"
            kubeval --strict --kubernetes-version ${{ env.KUBERNETES_VERSION }} "$file" || true
          done

      - name: Validate overlay manifests
        run: |
          echo "üîç Validando overlays..."
          for overlay in v4/k8s/overlays/*/; do
            echo "  Overlay: $overlay"
            find "$overlay" -name '*.yaml' -type f | while read file; do
              echo "    Checking: $file"
              kubeval --strict --kubernetes-version ${{ env.KUBERNETES_VERSION }} "$file" || true
            done
          done

      - name: Build and validate with Kustomize
        run: |
          echo "üîç Validando builds Kustomize..."

          # Instalar kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

          # Validar overlay dev
          if [ -d "v4/k8s/overlays/dev" ]; then
            echo "  Building: dev overlay"
            kustomize build v4/k8s/overlays/dev > /tmp/dev-manifest.yaml
            kubeval --strict /tmp/dev-manifest.yaml || echo "‚ö†Ô∏è Warnings in dev overlay"
          fi

          # Validar overlay prod
          if [ -d "v4/k8s/overlays/prod" ]; then
            echo "  Building: prod overlay"
            kustomize build v4/k8s/overlays/prod > /tmp/prod-manifest.yaml
            kubeval --strict /tmp/prod-manifest.yaml || echo "‚ö†Ô∏è Warnings in prod overlay"
          fi

  # ==========================================
  # Job 2: Verificar boas praticas com kube-score
  # ==========================================
  kube-score:
    name: Kube-score - Best Practices
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kube-score
        run: |
          wget -q https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64.tar.gz
          tar xf kube-score_1.17.0_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Score dev overlay
        run: |
          echo "üìä Analisando boas pr√°ticas (dev)..."
          if [ -d "v4/k8s/overlays/dev" ]; then
            kustomize build v4/k8s/overlays/dev | kube-score score - \
              --ignore-test container-ephemeral-storage-request-and-limit \
              --ignore-test pod-networkpolicy \
              --output-format ci || echo "‚ö†Ô∏è Algumas recomenda√ß√µes para dev"
          fi

      - name: Score prod overlay
        run: |
          echo "üìä Analisando boas pr√°ticas (prod)..."
          if [ -d "v4/k8s/overlays/prod" ]; then
            kustomize build v4/k8s/overlays/prod | kube-score score - \
              --output-format ci || echo "‚ö†Ô∏è Algumas recomenda√ß√µes para prod"
          fi

  # ==========================================
  # Job 3: Scan de seguranca com Trivy
  # ==========================================
  security-scan:
    name: Trivy - Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Scan dev manifests
        run: |
          echo "üîí Scan de seguran√ßa (dev)..."
          if [ -d "v4/k8s/overlays/dev" ]; then
            kustomize build v4/k8s/overlays/dev > /tmp/dev-manifest.yaml
            trivy config /tmp/dev-manifest.yaml --severity HIGH,CRITICAL --exit-code 0
          fi

      - name: Scan prod manifests
        run: |
          echo "üîí Scan de seguran√ßa (prod)..."
          if [ -d "v4/k8s/overlays/prod" ]; then
            kustomize build v4/k8s/overlays/prod > /tmp/prod-manifest.yaml
            trivy config /tmp/prod-manifest.yaml --severity HIGH,CRITICAL --exit-code 1 || echo "‚ùå Vulnerabilidades encontradas em prod!"
          fi

  # ==========================================
  # Job 4: Resumo final
  # ==========================================
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [kubeval, kube-score, security-scan]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "============================================"
          echo "        RESUMO DA VALIDA√á√ÉO"
          echo "============================================"
          echo ""
          echo "Kubeval (YAML):     ${{ needs.kubeval.result }}"
          echo "Kube-score (BP):    ${{ needs.kube-score.result }}"
          echo "Trivy (Security):   ${{ needs.security-scan.result }}"
          echo ""

          if [ "${{ needs.kubeval.result }}" == "failure" ] || \
             [ "${{ needs.kube-score.result }}" == "failure" ] || \
             [ "${{ needs.security-scan.result }}" == "failure" ]; then
            echo "‚ùå Algumas valida√ß√µes falharam. Revise os logs acima."
            exit 1
          else
            echo "‚úÖ Todas as valida√ß√µes passaram!"
          fi
